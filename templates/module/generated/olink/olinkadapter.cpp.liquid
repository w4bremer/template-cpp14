{% comment %} // Copyright (c) ApiGear UG 2020 {% endcomment -%}
{{ module | licGPLcpp -}}
{% capture class%}OLink{{interface.name}}Adapter{% endcapture %}

#include <iostream>
#include "{{module.name|identifier}}/generated/olink/{{interface.name|lower}}adapter.h"

//#include "../api/agent.h"
#include "{{module.name|identifier}}/generated/core/{{module.name|identifier}}.json.adapter.h"

using namespace {{ system.name | capital }}::{{ module.name | capital }};

{{class}}::{{class}}(I{{interface}}* impl, ApiGear::ObjectLink::RemoteRegistry& registry)
    : m_impl(impl)
    , m_node(nullptr)
    , m_registry(&registry)
{
    m_impl->_getPublisher()->subscribeTo{{interface.name | capital}}Interface(*this);
    m_registry->addObjectSource(this);
}

{{class}}::~{{class}}()
{
    m_registry->removeObjectSource(this);
    m_impl->_getPublisher()->unsubscribeFrom{{interface.name | capital}}Interface(*this);
}

nlohmann::json {{class}}::captureState()
{
    return nlohmann::json::object({
{% for property in interface.properties %}
        { "{{property.name}}", m_impl->{{property.name}}() }{% unless forloop.last %},{% endunless %}
{% endfor %}
    });
}

void {{class}}::applyState(const nlohmann::json& state)
{
{% for property in interface.properties %}
    if(state.contains("{{property}}")) {
        m_impl->set{{property.name|capitalize}}(state["{{property}}"]);
    }
{% else %}
    // no properties to apply state {% comment %} we generate anyway for consistency {% endcomment %}
    (void) state;
{% endfor %}
}


std::string {{class}}::olinkObjectName() {
    return "{{module}}.{{interface}}";
}

nlohmann::json {{class}}::olinkInvoke(std::string fcnName, nlohmann::json fcnArgs) {
    std::clog << fcnName << std::endl;
    std::string path = ApiGear::ObjectLink::Name::pathFromName(fcnName);
{% for operation in interface.operations %}
    if(path == "{{operation}}") {
{% for param in operation.params %}
        const {{param|cpp14Return}}& {{param}} = fcnArgs.at({{ forloop.index0 }});      
{% endfor %}
{% if operation.type == 'void' %}
        m_impl->{{operation}}({{ operation.params | map: 'name' | join: ', ' }});
        return nlohmann::json{};
{% else %}
        {{operation|cpp14Return}} result = m_impl->{{operation}}({{ operation.params | map: 'name' | join: ', ' }});
        return result;
{% endif %}
    }
{% else %}
    // no operations to invoke {% comment %} we generate anyway for consistency {% endcomment %}
    (void) fcnArgs;
{% endfor %}
    return nlohmann::json();
}

void {{class}}::olinkSetProperty(std::string name, nlohmann::json value) {
    std::clog << name << std::endl;
    std::string path = ApiGear::ObjectLink::Name::pathFromName(name);
{% for property in interface.properties %}
    if(path == "{{property}}") {
        {{property|cpp14Return}} {{property}} = value.get<{{property|cpp14Return}}>();
        m_impl->set{{property.name|capitalize}}({{property}});
    }
{% else %}
    // no properties to set {% comment %} we generate anyway for consistency {% endcomment %}
    (void) value;
{% endfor %} 
}

void {{class}}::olinkLinked(std::string name, ApiGear::ObjectLink::IRemoteNode *node) {
    std::clog << name << std::endl;
    m_node = node;
}

void {{class}}::olinkUnlinked(std::string name)
{
    std::clog << name << std::endl;
    m_node = nullptr;
}

nlohmann::json {{class}}::olinkCollectProperties()
{
    return captureState();
}

{% for signal in interface.signals %}
void {{class}}::On{{signal.name | capital}}(
        {%- for param in signal.params -%}
          {{param|cpp14Param}}{% unless forloop.last %},{% endunless -%}
        {%- endfor -%}
        )
{
    if(m_node != nullptr) {
        const nlohmann::json& args = { {{ signal.params | map: 'name' | join: ', ' }} };
        m_node->notifySignal("{{module}}.{{interface}}/{{signal}}", args);
    }
}
{% endfor %}

{% for property in interface.properties %}
void {{class}}::On{{property.name|capital}}Changed({{property|cpp14Return: true}} {{property}})
{
    if(m_node != nullptr) {
        m_node->notifyPropertyChange("{{module}}.{{interface}}/{{property}}", {{property}});
    }
}
{% endfor %}

